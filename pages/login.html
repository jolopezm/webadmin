<!doctype html>
<html lang="es">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Iniciar Sesión — Pymap Admin</title>
        <link rel="stylesheet" href="../css/estilo.css" />
        <link rel="icon" href="../favicon.ico" type="image/x-icon" />
    </head>
    <body>
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <div class="login-logo">PM</div>
                    <h1 class="login-title">Panel Administrativo</h1>
                    <p class="login-subtitle">
                        Ingresa tus credenciales para continuar
                    </p>
                </div>

                <div id="alert" class="alert"></div>

                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label" for="email"
                            >Correo Electrónico</label
                        >
                        <input
                            type="email"
                            id="email"
                            class="form-input"
                            placeholder="tu@email.com"
                            required
                            autocomplete="email"
                        />
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="password"
                            >Contraseña</label
                        >
                        <div class="password-toggle">
                            <input
                                type="password"
                                id="password"
                                class="form-input"
                                placeholder="••••••••"
                                required
                                autocomplete="current-password"
                            />
                            <button
                                type="button"
                                class="password-toggle-btn"
                                id="togglePassword"
                            >
                                mostrar
                            </button>
                        </div>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="remember" />
                        <label for="remember">Recordarme</label>
                    </div>

                    <button type="submit" class="btn-login" id="loginBtn">
                        Iniciar Sesión
                    </button>
                </form>

                <div class="divider">
                    <span>o</span>
                </div>

                <div class="link-secondary">
                    <a href="send-auth-code.html" id="forgotPassword"
                        >¿Olvidaste tu contraseña?</a
                    >
                </div>
            </div>
        </div>

        <script type="module">
            import { login } from '../js/api/auth-service.js'

            function isAuthenticated() {
                const token = localStorage.getItem('token')
                return !!token
            }

            if (isAuthenticated()) {
                window.location.href = '../index.html'
            }

            const loginForm = document.getElementById('loginForm')
            const emailInput = document.getElementById('email')
            const passwordInput = document.getElementById('password')
            const loginBtn = document.getElementById('loginBtn')
            const alert = document.getElementById('alert')
            const togglePasswordBtn = document.getElementById('togglePassword')

            togglePasswordBtn.addEventListener('click', () => {
                const type =
                    passwordInput.type === 'password' ? 'text' : 'password'
                passwordInput.type = type
                togglePasswordBtn.textContent =
                    type === 'password' ? 'mostrar' : 'ocultar'
            })

            function showAlert(message, type = 'error') {
                alert.textContent = message
                alert.className = `alert alert-${type} show`

                setTimeout(() => {
                    alert.classList.remove('show')
                }, 5000)
            }

            loginForm.addEventListener('submit', async e => {
                e.preventDefault()

                const email = emailInput.value.trim()
                const password = passwordInput.value

                if (!email || !password) {
                    showAlert('Por favor completa todos los campos', 'error')
                    return
                }

                loginBtn.disabled = true
                loginBtn.innerHTML =
                    '<span class="loading-spinner"></span>Iniciando sesión...'

                try {
                    const result = await login({ email, password })

                    if (result.access_token) {
                        showAlert('¡Bienvenido! Redirigiendo...', 'success')
                        setTimeout(() => {
                            window.location.href = '../index.html'
                        }, 1000)
                    }
                } catch (error) {
                    console.error('Error al iniciar sesión:', error)
                    showAlert(
                        error.message || 'Credenciales inválidas',
                        'error'
                    )

                    loginBtn.disabled = false
                    loginBtn.textContent = 'Iniciar Sesión'

                    emailInput.classList.add('error')
                    passwordInput.classList.add('error')

                    setTimeout(() => {
                        emailInput.classList.remove('error')
                        passwordInput.classList.remove('error')
                    }, 3000)
                }
            })
        </script>
    </body>
</html>
