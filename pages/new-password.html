<!doctype html>
<html lang="es">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Restablecer Contrase√±a ‚Äî Pymap Admin</title>
        <link rel="stylesheet" href="../css/estilo.css" />
        <link rel="icon" href="../favicon.ico" type="image/x-icon" />
        <style>
            .password-requirements {
                margin-top: 20px;
                padding: 16px;
                background: #f8f9fa;
                border-radius: 10px;
                font-size: 13px;
            }
            .password-requirements h3 {
                margin: 0 0 12px 0;
                font-size: 14px;
                color: #333;
                font-weight: 600;
            }
            .requirement {
                margin: 8px 0;
                color: #6b6b6b;
                padding-left: 20px;
                position: relative;
            }
            .requirement::before {
                position: absolute;
                left: 0;
                font-weight: bold;
            }
            .requirement.valid {
                color: #2e7d32;
            }
            .requirement.valid::before {
                content: '‚úì';
                color: #2e7d32;
            }
            .requirement.invalid::before {
                content: '‚úó';
                color: #c62828;
            }
        </style>
    </head>
    <body>
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <div class="login-logo">üîë</div>
                    <h1 class="login-title">Nueva Contrase√±a</h1>
                    <p class="login-subtitle">
                        Crea una contrase√±a segura para tu cuenta
                    </p>
                </div>

                <div
                    id="message"
                    class="alert"
                    role="status"
                    aria-live="polite"
                ></div>

                <form id="password-form">
                    <div class="form-group">
                        <label class="form-label" for="password"
                            >Nueva contrase√±a</label
                        >
                        <div class="password-toggle">
                            <input
                                type="password"
                                id="password"
                                class="form-input"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                required
                                autocomplete="current-password"
                            />
                            <button
                                type="button"
                                class="password-toggle-btn"
                                id="togglePassword"
                            >
                                mostrar
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="confirm-password"
                            >Confirmar contrase√±a</label
                        >
                        <input
                            id="confirm-password"
                            name="confirmPassword"
                            type="password"
                            class="form-input"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            required
                            autocomplete="new-password"
                        />
                    </div>

                    <div class="password-requirements">
                        <h3>Requisitos de la contrase√±a:</h3>
                        <div class="requirement" data-rule="length">
                            Al menos 8 caracteres
                        </div>
                        <div class="requirement" data-rule="uppercase">
                            Al menos una letra may√∫scula
                        </div>
                        <div class="requirement" data-rule="lowercase">
                            Al menos una letra min√∫scula
                        </div>
                        <div class="requirement" data-rule="number">
                            Al menos un n√∫mero
                        </div>
                        <div class="requirement" data-rule="special">
                            Al menos un car√°cter especial
                            (!@#$%^&*(),.?":{}|&lt;&gt;)
                        </div>
                        <div class="requirement" data-rule="match">
                            Las contrase√±as deben coincidir
                        </div>
                    </div>

                    <button
                        id="submit-btn"
                        type="submit"
                        class="btn-login"
                        disabled
                    >
                        Restablecer Contrase√±a
                    </button>
                </form>

                <div class="divider">
                    <span>o</span>
                </div>

                <div class="link-secondary">
                    <a href="send-auth-code.html">‚Üê Volver</a>
                </div>
            </div>
        </div>

        <script type="module">
            import { resetPassword } from '../js/api/auth-service.js'

            const passwordForm = document.getElementById('password-form')
            const passwordInput = document.getElementById('password')
            const confirmPasswordInput =
                document.getElementById('confirm-password')
            const submitBtn = document.getElementById('submit-btn')
            const messageEl = document.getElementById('message')
            const togglePasswordBtn = document.getElementById('togglePassword')

            togglePasswordBtn.addEventListener('click', () => {
                const type =
                    passwordInput.type === 'password' ? 'text' : 'password'
                passwordInput.type = type
                togglePasswordBtn.textContent =
                    type === 'password' ? 'mostrar' : 'ocultar'
            })

            const email = sessionStorage.getItem('resetEmail')
            if (!email) {
                setMessage(
                    'Sesi√≥n expirada. Por favor, inicia el proceso nuevamente.',
                    'error'
                )
                setTimeout(() => {
                    window.location.href = 'send-auth-code.html'
                }, 2000)
            }

            function setMessage(text, type = '') {
                messageEl.textContent = text
                messageEl.className = type
                    ? `alert alert-${type} show`
                    : 'alert'
            }

            const passwordRules = {
                length: password => password.length >= 8,
                uppercase: password => /[A-Z]/.test(password),
                lowercase: password => /[a-z]/.test(password),
                number: password => /[0-9]/.test(password),
                special: password => /[!@#$%^&*(),.?":{}|<>]/.test(password),
                match: () => {
                    const pwd = passwordInput.value
                    const confirm = confirmPasswordInput.value
                    return confirm.length > 0 && pwd === confirm
                },
            }

            function validatePassword() {
                const password = passwordInput.value
                let allValid = true

                Object.keys(passwordRules).forEach(rule => {
                    if (rule === 'match') return

                    const element = document.querySelector(
                        `[data-rule="${rule}"]`
                    )
                    const isValid = passwordRules[rule](password)

                    element.classList.toggle('valid', isValid)
                    element.classList.toggle('invalid', !isValid)

                    if (!isValid) allValid = false
                })

                validateMatch()

                return allValid
            }

            function validateMatch() {
                const matchElement = document.querySelector(
                    '[data-rule="match"]'
                )
                const password = passwordInput.value
                const confirmPassword = confirmPasswordInput.value

                if (confirmPassword.length === 0) {
                    matchElement.classList.remove('valid', 'invalid')
                    return false
                }

                const isMatch =
                    password === confirmPassword && password.length > 0
                matchElement.classList.toggle('valid', isMatch)
                matchElement.classList.toggle('invalid', !isMatch)

                return isMatch
            }

            function checkFormValidity() {
                const password = passwordInput.value
                const confirmPassword = confirmPasswordInput.value

                if (!password || !confirmPassword) {
                    submitBtn.disabled = true
                    return
                }

                const allRulesValid = Object.keys(passwordRules).every(rule =>
                    passwordRules[rule](password)
                )

                submitBtn.disabled = !allRulesValid
            }

            passwordInput.addEventListener('input', () => {
                validatePassword()
                checkFormValidity()
            })

            confirmPasswordInput.addEventListener('input', () => {
                validateMatch()
                checkFormValidity()
            })

            passwordForm.addEventListener('submit', async e => {
                e.preventDefault()
                setMessage('')

                const password = passwordInput.value.trim()
                const confirmPassword = confirmPasswordInput.value.trim()

                if (password !== confirmPassword) {
                    setMessage('Las contrase√±as no coinciden.', 'error')
                    return
                }

                const allValid = Object.keys(passwordRules).every(rule =>
                    passwordRules[rule](password)
                )

                if (!allValid) {
                    setMessage(
                        'La contrase√±a no cumple con todos los requisitos.',
                        'error'
                    )
                    return
                }

                submitBtn.disabled = true
                submitBtn.innerHTML =
                    '<span class="loading-spinner"></span>Restableciendo...'

                try {
                    await resetPassword({
                        email: email,
                        new_password: password,
                    })

                    setMessage(
                        '¬°Contrase√±a restablecida exitosamente!',
                        'success'
                    )

                    sessionStorage.removeItem('resetEmail')

                    setTimeout(() => {
                        window.location.href = 'login.html'
                    }, 1500)
                } catch (err) {
                    console.error(err)
                    setMessage(
                        err?.message ||
                            'Error al restablecer la contrase√±a. Intenta nuevamente.',
                        'error'
                    )
                    submitBtn.disabled = false
                    submitBtn.textContent = 'Restablecer Contrase√±a'
                }
            })
        </script>
    </body>
</html>
